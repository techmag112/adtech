# SF AdTech Система

Сделано в качестве практического задания на курсе **PHP**

## Назначение системы
Трекер трафика, созданный для организации взаимодействия компаний (рекламодателей), которые хотят привлечь к себе на сайт посетителей и покупателей (клиентов), и владельцев сайтов (веб-мастеров), на которые люди приходят, например, чтобы почитать новости или пообщаться на форуме.

## Описание функционала
Рекламодатель создаёт предложение (offer), определяя URL страницы, на которую он хочет приводить людей. В offer-е он также определяет стоимость перехода по ссылке. Скажем, 1 рубль за переход.

Веб-мастера в системе видят создаваемые офферы, подписываются на них, после чего система выдаёт им специальные ссылки, которые они должны разместить в любом виде у себя на ресурсе. Ссылка эта ведёт не на целевой URL, а на систему-редиректор, которая фиксирует переход, а затем перенаправляет клиента на страницу сайта рекламодателя.

По итогам рекламодатель получает N посетителей и платит за это системе N рублей. Система определяет комиссию (например, 20%) за свои услуги. Таким образом, веб-мастер за привлечение клиентов, получит 0.8*N рублей, а система заработает 0.2*N рублей.

## Требования 
Требуются PHP версии 8 и более и MySQL версии 6+.

## Документирование кода
Весь код документирован по стандарту **PHPDoc** ([PSR-5](https://github.com/php-fig/fig-standards/blob/master/proposed/phpdoc.md)) (все классы, методы, переменные и результаты возвратов). Это позволяет автоматизировать процесс создания рабочей документации с помощью пакета [phpDocumentor](https://www.phpdoc.org/).

## Описание таблиц 
Структура таблиц подробнее по [ссылке](/docs/db.md)

## Описание интерфейса
В зависимости от роли пользователя после авторизации он автоматически переключается на один из трех интерфейсов:
- [Панель заказчика](docs/offer.md)
- [Панель веб-мастера](docs/webmaster.md)
- [Панель администратора](docs/admin.md)

## Защита от SQL-injection, CSRF attack, XSS attack
Защита от SQL-injection делается с помощью внешней зависимости подключения к базе данных **delight-im/db** - обертке PDO, внешние данные передаются в запросы как неисполняемые параметры.
Защита от CSRF attack делается с помощью генерации и подстановки в форму скрытого токена с его последующей проверкой на сервере для авторизированных пользователей.
Защита от XSS attack - входящие данные экранируются функцией **htmlspecialchars** в php и ее реализацией в js.

## Тестирование
Для генерации новых данных для теста можно использовать страницу [tests.html](tests.html)
Она содержит 5 тестовых ссылок:
- Тест 1 Действующий оффер 1 
- Тест 2 Действующий оффер 2 
- Тест 3 Деактивированный оффер 
- Тест 4 Действующий оффер, но мастер не подписан 
- Тест 5 Несуществующий оффер 

## Настройки подключения к базе данных
Дамп базы данных лежит в корне.
Настройки подключения к базе данных находятся к классе Router:
```
PDO::class => function() {
    $driver = "mysql";
    $host = "localhost";
    $port = 3306;
    $database_name = "adtech";
    $username = "root";
    $password = "";
    $mypdo = new PDO("$driver:host=$host:$port;dbname=$database_name", $username, $password);
    return $mypdo;
},
```
## Запуск тестовой среды
В качестве тестовой среды предлагается использовать платформу для быстрого развертывания и тестирования приложений  [Docker](https://www.docker.com/) Благодаря ей загрузка базы данных, ее настроек, настроек серверов http, php и их расширений, а также необходимых зависимостей - автоматизировано.
В директории docker лежит уже настроенный профиль контейнера.<br>
Необходимо:
1. Скопировать директорию профиля докера со всем содержимым к себе на диск и запустить приложение **Docker Desktop**.
2. В директорию **code** скопировать файлы проекта с **github** (директории public и src + файлы в корне), кроме дампа **adtech.sql**.
Дамп **adtech.sql** скопировать в директорию **data**. 
3. Через терминал зайти в директорию, где развернут профиль докера. Запустить команду **docker-compose up -d --build** 
Дождаться появления зеленых надписей:<br>
[+] Running 5/5<br>
 ✔ Network adtech_adtech-network  Created<br>
 ✔ Container db                   Started<br>
 ✔ Container phpmyadmin           Started<br>
 ✔ Container app                  Started<br>
 ✔ Container webserver            Started<br>
Никаких дополнительных настроек или загрузок данных не требуется, проект развернется и подтянет все необходимые данные автоматически. 
4. Проект доступен по адресу **localhost** (можно сделать на отдельное доменное имя, но придется вмешиваться в настройки hosts Windows).
5. Последующие остановка / старт проект - команды **docker-compose stop** и **docker-compose start**, набранные через терминал в директории, где развернут профиль докера.
6. Для контроля состояния/изменения базы используется приложение phpMyAdmin (сервер **db**, логин **admin** пароль **12345**) (входит в состав контейнера).
7. Пароли всех пользователей - 123456789.

## Лицензия
Лицензия MIT. Более подробно - по [ссылке](/docs/licence.md).


